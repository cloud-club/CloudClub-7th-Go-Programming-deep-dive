# grpc-chat-app with Kafka

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ì „ì²´ êµ¬ì¡°ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   gRPC Client   â”‚    â”‚   gRPC Client   â”‚    â”‚   gRPC Client   â”‚
â”‚     (Alice)     â”‚    â”‚      (Bob)      â”‚    â”‚    (Charlie)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â”‚ gRPC CreateStream    â”‚ gRPC BroadcastMessageâ”‚ gRPC CreateStream
          â”‚ & BroadcastMessage   â”‚                      â”‚ & BroadcastMessage
          â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    gRPC Chat Server                             â”‚
â”‚                    (Message Gateway)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Connection     â”‚  â”‚  Connection     â”‚  â”‚  Connection     â”‚ â”‚
â”‚  â”‚   Pool          â”‚  â”‚   Pool          â”‚  â”‚   Pool          â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ - Kafka Producerâ”‚  â”‚ - User Sessions â”‚  â”‚ - Message       â”‚ â”‚
â”‚  â”‚ - User Sessions â”‚  â”‚ - gRPC Streams  â”‚  â”‚   Broadcasting  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                                   â”‚
                  â”‚ Publish Messages                  â”‚ Receive Processed
                  â”‚ & User Events                     â”‚ Messages
                  â–¼                                   â–²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Kafka Cluster                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   kafka-01      â”‚  â”‚   kafka-02      â”‚  â”‚   kafka-03      â”‚ â”‚
â”‚  â”‚   (Broker 1)    â”‚  â”‚   (Broker 2)    â”‚  â”‚   (Broker 3)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  Topics:                                                        â”‚
â”‚  - chatting (2 partitions, 2 replicas)                        â”‚
â”‚  - user-connections (3 partitions, 2 replicas)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                                   â”‚
                  â”‚ Consume Messages                  â”‚ Consume User
                  â”‚ & Process                         â”‚ Events
                  â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Message Processor                             â”‚
â”‚                   (Kafka Consumer)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Chat Message    â”‚  â”‚ User Connection â”‚  â”‚ Server Registry â”‚ â”‚
â”‚  â”‚ Handler         â”‚  â”‚ Handler         â”‚  â”‚ & Cleanup       â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ - Parse Messagesâ”‚  â”‚ - Track Users   â”‚  â”‚ - Monitor       â”‚ â”‚
â”‚  â”‚ - Route to      â”‚  â”‚ - Update Server â”‚  â”‚   Servers       â”‚ â”‚
â”‚  â”‚   Servers       â”‚  â”‚   Registry      â”‚  â”‚ - Health Check  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ìš” ì»´í¬ë„ŒíŠ¸

#### 1. gRPC Chat Server (Message Gateway)

- **ì—­í• **: í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ê´€ë¦¬ ë° ë©”ì‹œì§€ ê²Œì´íŠ¸ì›¨ì´
- **ê¸°ëŠ¥**:
  - í´ë¼ì´ì–¸íŠ¸ gRPC ì—°ê²° ê´€ë¦¬
  - ë©”ì‹œì§€ë¥¼ Kafkaë¡œ ë°œí–‰ (Producer ì—­í• )
  - ì‚¬ìš©ì ì—°ê²°/í•´ì œ ì´ë²¤íŠ¸ë¥¼ Kafkaë¡œ ì „ì†¡
  - ë‹¤ì¤‘ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ì§€ì› (ìˆ˜í‰ í™•ì¥ ê°€ëŠ¥)

#### 2. Kafka Cluster

- **ì—­í• **: ë¶„ì‚° ë©”ì‹œì§€ ë¸Œë¡œì»¤
- **êµ¬ì„±**: 3ê°œ ë¸Œë¡œì»¤, Zookeeper í¬í•¨
- **í† í”½**:
  - `chatting`: ì±„íŒ… ë©”ì‹œì§€ (2 íŒŒí‹°ì…˜, 2 ë³µì œë³¸)
  - `user-connections`: ì‚¬ìš©ì ì—°ê²° ì´ë²¤íŠ¸ (3 íŒŒí‹°ì…˜, 2 ë³µì œë³¸)

#### 3. Message Processor (Kafka Consumer)

- **ì—­í• **: ë©”ì‹œì§€ ì²˜ë¦¬ ë° ë¼ìš°íŒ…
- **ê¸°ëŠ¥**:
  - Kafkaì—ì„œ ë©”ì‹œì§€ ì†Œë¹„
  - ì„œë²„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê´€ë¦¬
  - ë©”ì‹œì§€ ë¼ìš°íŒ… ë° ë¶„ì‚° ì²˜ë¦¬
  - ë¹„í™œì„± ì„œë²„ ì •ë¦¬

## ğŸš€ ì‹œì‘í•˜ê¸°

### ì‚¬ì „ ì¤€ë¹„ì‚¬í•­

- Go 1.19+
- Docker & Docker Compose
- Make (ì„ íƒì‚¬í•­, í¸ì˜ë¥¼ ìœ„í•´)

### ì„¤ì¹˜ ë° ì„¤ì •

1. **ì˜ì¡´ì„± ì„¤ì¹˜**

```bash
go mod tidy
```

2. **Kafka í´ëŸ¬ìŠ¤í„° ì‹œì‘**

```bash
make kafka-up
# ë˜ëŠ”
docker-compose up -d
```

3. **Protobuf ì½”ë“œ ìƒì„±** (í•„ìš”í•œ ê²½ìš°)

```bash
make proto
# ë˜ëŠ”
protoc --go_out=. --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    proto/chat.proto
```

### ì‹¤í–‰ ë°©ë²•

#### ë°©ë²• 1: Make ì‚¬ìš© (ê¶Œì¥)

```bash
# 1. Kafka í´ëŸ¬ìŠ¤í„° ì‹œì‘
make kafka-up

# 2. gRPC ì„œë²„ ì‹œì‘ (í„°ë¯¸ë„ 1)
make server

# 3. Message Processor ì‹œì‘ (í„°ë¯¸ë„ 2)
make consumer

# 4. í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰ (í„°ë¯¸ë„ 3, 4, ...)
make client USER=alice
make client USER=bob
```

#### ë°©ë²• 2: ì§ì ‘ ì‹¤í–‰

```bash
# 1. Kafka ì‹œì‘
docker-compose up -d

# 2. gRPC ì„œë²„ ì‹¤í–‰
go run main.go

# 3. Consumer ì‹¤í–‰ (ìƒˆ í„°ë¯¸ë„)
go run consumer.go consumer

# 4. í´ë¼ì´ì–¸íŠ¸ ì‹¤í–‰ (ìƒˆ í„°ë¯¸ë„ë“¤)
go run client.go alice
go run client.go bob
```

## ğŸ“Š ëª¨ë‹ˆí„°ë§

### Kafka UI

- **URL**: http://localhost:8080
- **ê¸°ëŠ¥**: í† í”½, ë©”ì‹œì§€, ì»¨ìŠˆë¨¸ ê·¸ë£¹ ëª¨ë‹ˆí„°ë§

### ë¡œê·¸ í™•ì¸

- **ì„œë²„ ë¡œê·¸**: ì—°ê²° ê´€ë¦¬, Kafka ë°œí–‰ ìƒíƒœ
- **Consumer ë¡œê·¸**: ë©”ì‹œì§€ ì²˜ë¦¬, ì„œë²„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìƒíƒœ
- **í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸**: ì—°ê²° ìƒíƒœ, ë©”ì‹œì§€ ì†¡ìˆ˜ì‹ 

## ğŸ”§ ìƒì„¸ ê¸°ëŠ¥ ì„¤ëª…

### 1. ë©”ì‹œì§€ íë¦„

#### ë©”ì‹œì§€ ì „ì†¡ ê³¼ì •

1. **í´ë¼ì´ì–¸íŠ¸**: `BroadcastMessage` gRPC í˜¸ì¶œ
2. **gRPC ì„œë²„**: ë©”ì‹œì§€ë¥¼ JSONìœ¼ë¡œ ì§ë ¬í™”í•˜ì—¬ Kafka `chatting` í† í”½ì— ë°œí–‰
3. **Message Processor**: Kafkaì—ì„œ ë©”ì‹œì§€ ì†Œë¹„
4. **Message Processor**: ì—°ê²°ëœ ëª¨ë“  ì„œë²„ë¡œ ë©”ì‹œì§€ ë¼ìš°íŒ… (í˜„ì¬ëŠ” ë¡œê·¸ë¡œ ì‹œë®¬ë ˆì´ì…˜)
5. **gRPC ì„œë²„**: ë¡œì»¬ ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ë“¤ì—ê²Œ ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸

#### ì‚¬ìš©ì ì—°ê²° ê´€ë¦¬

1. **í´ë¼ì´ì–¸íŠ¸ ì—°ê²°**: `CreateStream` gRPC í˜¸ì¶œ
2. **gRPC ì„œë²„**: ì—°ê²° ì •ë³´ë¥¼ `user-connections` í† í”½ì— ë°œí–‰
3. **Message Processor**: ì‚¬ìš©ì ì—°ê²° ì´ë²¤íŠ¸ ì²˜ë¦¬ ë° ì„œë²„ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì—…ë°ì´íŠ¸
4. **ì—°ê²° í•´ì œ**: ì—°ê²° ì¢…ë£Œ ì‹œ í•´ì œ ì´ë²¤íŠ¸ ë°œí–‰

### 2. í•µì‹¬ ë°ì´í„° êµ¬ì¡°

#### ChatMessage (Kafka ë©”ì‹œì§€)

```go
type ChatMessage struct {
    ID        string    `json:"id"`        // ë©”ì‹œì§€ ê³ ìœ  ID
    Content   string    `json:"content"`   // ë©”ì‹œì§€ ë‚´ìš©
    Timestamp time.Time `json:"timestamp"` // ì „ì†¡ ì‹œê°„
    UserID    string    `json:"user_id"`   // ë°œì‹ ì ID
}
```

#### UserConnection (ì—°ê²° ì´ë²¤íŠ¸)

```go
type UserConnection struct {
    UserID    string    `json:"user_id"`    // ì‚¬ìš©ì ID
    ServerID  string    `json:"server_id"`  // ì„œë²„ ID
    Connected bool      `json:"connected"`  // ì—°ê²° ìƒíƒœ
    Timestamp time.Time `json:"timestamp"`  // ì´ë²¤íŠ¸ ì‹œê°„
}
```

### 3. Kafka ì„¤ì •

#### Producer ì„¤ì •

- **RequiredAcks**: `WaitForAll` (ëª¨ë“  ë³µì œë³¸ í™•ì¸)
- **Retry**: ìµœëŒ€ 5íšŒ
- **Return Successes**: `true`

#### Consumer ì„¤ì •

- **Consumer Group**: `chatting-processor-group`
- **Offset**: `OffsetNewest` (ìµœì‹  ë©”ì‹œì§€ë¶€í„°)
- **Rebalance Strategy**: `RoundRobin`

## ğŸ—ï¸ í™•ì¥ ê³ ë ¤ì‚¬í•­

### ìˆ˜í‰ í™•ì¥

1. **gRPC ì„œë²„**: ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ ì‹¤í–‰ ê°€ëŠ¥ (ë¡œë“œ ë°¸ëŸ°ì„œ í•„ìš”)
2. **Message Processor**: Consumer Groupìœ¼ë¡œ ë¶„ì‚° ì²˜ë¦¬
3. **Kafka**: íŒŒí‹°ì…˜ ìˆ˜ ì¦ê°€ë¡œ ì²˜ë¦¬ëŸ‰ í–¥ìƒ

### ì¶”ê°€ ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •

- [ ] ì‹¤ì œ ì„œë²„ ê°„ gRPC í†µì‹ 
- [ ] ë©”ì‹œì§€ ì§€ì†ì„± (ë°ì´í„°ë² ì´ìŠ¤)
- [ ] ì‚¬ìš©ì ì¸ì¦ ë° ê¶Œí•œ
- [ ] ì±„íŒ…ë°©/ì±„ë„ ê¸°ëŠ¥
- [ ] ë©”ì‹œì§€ ì•”í˜¸í™”
- [ ] ì›¹ í´ë¼ì´ì–¸íŠ¸ (WebSocket)

## ğŸ§ª í…ŒìŠ¤íŠ¸

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```bash
make test
# ë˜ëŠ”
go test ./...
```

### Postmanìœ¼ë¡œ gRPC í…ŒìŠ¤íŠ¸

ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ **gRPC Reflection**ì´ í™œì„±í™”ë˜ì–´ ìˆì–´ Postmanì—ì„œ ì‰½ê²Œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ë¹ ë¥¸ ì‹œì‘

1. **ì„œë²„ ì‹¤í–‰**:

   ```bash
   make kafka-up
   make server
   ```

2. **Postman ì„¤ì •**:

   - ìƒˆ gRPC ìš”ì²­ ìƒì„±
   - ì„œë²„ URL: `localhost:8081`
   - "Use Server Reflection" í™œì„±í™”
   - `chat.Broadcast` ì„œë¹„ìŠ¤ í™•ì¸

3. **í…ŒìŠ¤íŠ¸ ì˜ˆì œ**:
   ```json
   // BroadcastMessage í…ŒìŠ¤íŠ¸
   {
     "id": "postman-user",
     "content": "Hello from Postman!",
     "timestamp": null
   }
   ```

ğŸ“‹ **ìƒì„¸í•œ Postman í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ**: [postman-guide.md](./postman-guide.md)

### í†µí•© í…ŒìŠ¤íŠ¸

```bash
# ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
make kafka-up
sleep 15
make server &
make consumer &
sleep 5
make client USER=testuser1 &
make client USER=testuser2 &
wait
```

## ğŸ› ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ë¬¸ì œ

#### Kafka ì—°ê²° ì‹¤íŒ¨

```bash
# Kafka ìƒíƒœ í™•ì¸
docker-compose ps
docker-compose logs kafka-01

# ì¬ì‹œì‘
make kafka-down
make kafka-up
```

#### í¬íŠ¸ ì¶©ëŒ

- gRPC ì„œë²„: 8081 (ê¸°ë³¸ê°’)
- Kafka UI: 8080
- Kafka ë¸Œë¡œì»¤: 9092, 9093, 9094

#### ë©”ëª¨ë¦¬ ë¶€ì¡±

```bash
# Docker ë©”ëª¨ë¦¬ í• ë‹¹ í™•ì¸ ë° ì¦ê°€
docker system info
```

### ë¡œê·¸ ë¶„ì„

#### ì„±ê³µì ì¸ ë©”ì‹œì§€ íë¦„

```
# gRPC ì„œë²„ ë¡œê·¸
User alice connected to server grpc-server-1234567890
Message sent to Kafka - Topic: chatting, Partition: 1, Offset: 5

# Consumer ë¡œê·¸
Received chat message: Topic=chatting, Partition=1, Offset=5
Processing chat message: ID=alice, Content=Hello World!, From=alice
Message broadcast completed for message ID: alice

# í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸
Connected to server as user: alice
Message sent: Hello World!
[15:04:05] alice: Hello World!
```

## ğŸ“š ì°¸ê³  ìë£Œ

- [Kafkaë¥¼ ì´ìš©í•œ chatting í”„ë¡œê·¸ë¨ ê°œë°œ - joinc.co.kr](https://joinc.co.kr/w/man/12/Kafka/chatting)
- [gRPC Documentation](https://grpc.io/docs/)
- [Apache Kafka Documentation](https://kafka.apache.org/documentation/)
- [Sarama - Go Kafka Client](https://github.com/IBM/sarama)

## ğŸ“„ ë¼ì´ì„ ìŠ¤

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
